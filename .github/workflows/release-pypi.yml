name: Release to PyPI

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  actions: read
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    # Set up such that PyPI Trusted Publishing (OIDC) can work.
    permissions:
      id-token: write
      actions: read
      contents: read

    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Ensure tag commit is latest on main
        id: main_guard
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const main = await github.rest.repos.getBranch({
              owner,
              repo,
              branch: 'main',
            });

            const mainSha = main.data.commit.sha;
            const tagSha = context.sha;

            core.info(`main HEAD: ${mainSha}`);
            core.info(`tag commit: ${tagSha}`);

            if (mainSha !== tagSha) {
              core.setFailed(
                `Tag commit (${tagSha}) is not the latest commit on main (${mainSha}). ` +
                'Create the release tag from current main HEAD to ensure the publish uses the newest built artifact.'
              );
              return;
            }

            core.setOutput('release_sha', tagSha);

      - name: Wait for successful CI build artifact
        id: find_build
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = '${{ steps.main_guard.outputs.release_sha }}';
            const maxAttempts = 30;   // 30 × 20 s = 10 minutes
            const delayMs = 20_000;   // 20 seconds between polls

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: 'ci.yml',
                head_sha: sha,
                event: 'push',
                status: 'completed',
                per_page: 50,
              });

              const success = runs.data.workflow_runs.find(r => r.conclusion === 'success');
              if (success) {
                core.info(`Found successful CI run ${success.id} (${success.html_url})`);
                core.setOutput('run_id', String(success.id));
                return;
              }

              const failed = runs.data.workflow_runs.find(r => r.conclusion === 'failure');
              if (failed) {
                core.setFailed(
                  `CI run ${failed.id} failed for commit ${sha}. ` +
                  'Fix CI before releasing.'
                );
                return;
              }

              if (attempt < maxAttempts) {
                core.info(`Attempt ${attempt}/${maxAttempts}: CI not finished yet — waiting ${delayMs / 1000}s …`);
                await new Promise(r => setTimeout(r, delayMs));
              }
            }

            core.setFailed(
              `No successful CI run found for commit ${sha} after ${maxAttempts} attempts (≈10 min). ` +
              'Check whether the CI workflow was triggered for this commit.'
            );

      - name: Download built dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          run-id: ${{ steps.find_build.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: dist

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"

      - name: Validate downloaded package metadata
        run: uv run --with twine python -m twine check dist/*

      - name: Publish to PyPI (Trusted Publisher)
        run: uv publish dist/*
